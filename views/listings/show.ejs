<% layout("/layouts/boilerplate") %>
<script>
    const mapToken = "<%= process.env.MAP_TOKEN %>";
    const listing = <%- JSON.stringify(listing) %>
</script>

<div class="container mt-3">
    <div class="row justify-content-center">
        <div class="col-10 text-center">
            <h3 class="mb-4"><%= listing.title %></h3>
        </div>

        <!-- Listing Card -->
        <div class="col-md-6 col-lg-6">
            <div class="card shadow-sm">
                <!-- Carousel for Images -->
                <div id="imageCarousel<%= listing._id %>" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <% listing.images.forEach((image, index) => { %>
                            <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                                <img
                                        src="<%= image.url %>"
                                        class="d-block w-100 rounded-top"
                                        alt="listing_image"
                                        style="max-height: 320px; object-fit: cover;"
                                />
                            </div>
                        <% }); %>
                    </div>

                    <% if (listing.images.length > 1) { %>
                        <!-- Left and Right Buttons -->
                        <button class="carousel-control-prev" type="button" data-bs-target="#imageCarousel<%= listing._id %>" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel<%= listing._id %>" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    <% } %>
                </div>

                <p class="card-text text-muted mt-2">Owned by <%= listing.owner.username %></p>

                <div class="card-body">
                    <p class="card-text text-muted mb-2"><%= listing.description %></p>
                    <hr>
                    <p class="card-text mb-1">
                        <strong>Price:</strong> &#8377;<%= listing.price.toLocaleString("en-IN") %>
                    </p>
                    <p class="card-text mb-1">
                        <strong>Location:</strong> <%= listing.location %>, <%= listing.country %>
                    </p>
                </div>
            </div>
        </div>

        <!-- Edit/Delete Options for Owner -->
        <% if (currUser && currUser._id.equals(listing.owner._id)) { %>
            <div class="col-12 text-center mt-2 mb-2">
                <div class="d-flex justify-content-center align-items-center gap-3">
                    <!-- Edit Button -->
                    <a href="/listings/<%= listing._id %>/edit" class="mr-3">
                        <button class="editBtn">
                            <svg viewBox="0 0 512 512" height="1em">
                                <path
                                        d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.1 22.7c-4 3.1-8.5 5.4-13.3 6.9L59.4 452l23-78.1c1.4-4.9 3.8-9.4 6.9-13.3l22.7-9.1v32c0 8.8 7.2 16 16 16h32zM362.7 18.7L348.3 33.2 325.7 55.8 314.3 67.1l33.9 33.9 62.1 62.1 33.9 33.9 11.3-11.3 22.6-22.6 14.5-14.5c25-25 25-65.5 0-90.5L453.3 18.7c-25-25-65.5-25-90.5 0zm-47.4 168l-144 144c-6.2 6.2-16.4 6.2-22.6 0s-6.2-16.4 0-22.6l144-144c6.2-6.2 16.4-6.2 22.6 0s6.2 16.4 0 22.6z"
                                ></path>
                            </svg>
                            Edit
                        </button>
                    </a>
                    <!-- Delete Button -->
                    <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="d-inline mb-1">
                        <button type="button" class="button ml-3">
                            <span class="button__text">Delete</span>
                            <span class="button__icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="512" viewBox="0 0 512 512" height="512" class="svg">
                            <title></title>
                            <path
                                    style="fill:none;stroke:#323232;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"
                                    d="M112,112l20,320c.95,18.49,14.4,32,32,32H348c17.67,0,30.87-13.51,32-32l20-320"
                            ></path>
                            <line
                                    y2="112"
                                    y1="112"
                                    x2="432"
                                    x1="80"
                                    style="stroke:#323232;stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px"
                            ></line>
                            <path
                                    style="fill:none;stroke:#323232;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"
                                    d="M192,112V72h0a23.93,23.93,0,0,1,24-24h80a23.93,23.93,0,0,1,24,24h0v40"
                            ></path>
                            <line
                                    y2="400"
                                    y1="176"
                                    x2="256"
                                    x1="256"
                                    style="fill:none;stroke:#323232;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"
                            ></line>
                            <line
                                    y2="400"
                                    y1="176"
                                    x2="192"
                                    x1="184"
                                    style="fill:none;stroke:#323232;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"
                            ></line>
                            <line
                                    y2="400"
                                    y1="176"
                                    x2="320"
                                    x1="328"
                                    style="fill:none;stroke:#323232;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"
                            ></line>
                        </svg>
                    </span>
                        </button>
                    </form>
                </div>
            </div>
        <% } %>
        <hr>

        <!-- Review Form -->
        <% if(currUser) { %>
            <div class="container mt-4 mb-4 p-4 bg-light rounded shadow-sm" style="max-width: 600px;">
                <h4 class="mb-3">Leave a Review</h4>
                <form action="/listings/<%= listing.id %>/reviews" method="POST" novalidate class="needs-validation">
                    <!-- Star Rating System -->
                    <div class="rating">
                        <input value="5" name="review[rating]" id="star5" type="radio">
                        <label title="5" for="star5"></label>
                        <input value="4" name="review[rating]" id="star4" type="radio">
                        <label title="4" for="star4"></label>
                        <input value="3" name="review[rating]" id="star3" type="radio" checked="">
                        <label title="3" for="star3"></label>
                        <input value="2" name="review[rating]" id="star2" type="radio">
                        <label title="2" for="star2"></label>
                        <input value="1" name="review[rating]" id="star1" type="radio">
                        <label title="1" for="star1"></label>
                    </div>

                    <!-- Comment Section -->
                    <div class="mb-3">
                        <label for="comment" class="form-label">Comments</label>
                        <textarea class="form-control" name="review[comment]" id="comment" rows="4" placeholder="Write your comments here..." required></textarea>
                        <div class="invalid-feedback">
                            Please add some valid feedback
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Submit</button>
                </form>
            </div>
        <% } %>

        <!-- Reviews Section -->
        <% if(listing.reviews.length > 0) { %>
            <div class="container mt-4 mb-4 p-4 bg-white rounded shadow-sm" style="max-width: 600px;">
                <h4 class="mb-3">Reviews</h4>
                <% listing.reviews.forEach(function(review) { %>
                    <div class="review-item mb-3 p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">Rating:
                                <% for (let i = 1; i <= 5; i++) { %>
                                    <% if (i <= review.rating) { %>
                                        <span style="color: #ffa723;">★</span>
                                    <% } else { %>
                                        <span>★</span>
                                    <% } %>
                                <% } %>
                            </span>
                            <span class="text-muted small"><%= new Date(review.createdAt).toLocaleDateString() %></span>
                        </div>
                        <p class="mb-0"><%= review.comment %></p>
                        <p class="text-muted small">By <%= review.author.username %></p>
                        <% if(currUser && currUser._id.equals(review.author._id)) { %>
                            <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" class="d-inline">
                                <button class="btn btn-outline-danger btn-sm mt-2">Delete</button>
                            </form>
                        <% } %>
                    </div>
                <% }); %>
            </div>
            <hr>
        <% } %>
    </div>

    <!-- Map Section -->
    <div class="mt-4 mb-4">
        <h3 class="mb-3 text-center">Where you'll be</h3>
        <div id="map" class="rounded shadow-sm mx-auto" style="width: 1000px; max-width: 100%; height: 500px;"></div>
    </div>
</div>
